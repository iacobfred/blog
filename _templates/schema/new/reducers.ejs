---
to: apps/web/graphql/generated/reducers/<%= name %>.reducer.ts
force: true
---
<% names = h.inflection.pluralize(name); -%>
<% requiredFields = Object.fromEntries(Object.entries(selectableFields).filter(([fieldName, field]) => field.required)); -%>
<% initiallyRequiredFieldEntries = Object.entries(requiredFields).filter(([fieldName, field]) => (field.type !== "String" && typeof field.initialize === "undefined" && typeof field.default === "undefined" && field.type !== "Array")); -%>
<% requiredStringFieldEntries = Object.entries(requiredFields).filter(([fieldName, field]) => field.type === "String"); -%>
<% requireUserId = Object.entries(requiredFields).some(([fieldName, field]) => fieldName === "userId"); -%>
/* Do not edit this file. It was generated programmatically. */
// import <%= Name %> from "@web/graphql/generated/types/<%= Name %>";
import { <%= Name %>CreationInput } from "@web/graphql/generated/inputs/<%= name %>.inputs";
import { ID } from "@web/graphql/schema/types";
import { Payload, ArrayAction, arrayReducer } from "@web/utils/data/reduction";
import { <%= Name %>Fragment } from "@web/graphql/generated/fragments/<%= name %>.fragment";
<% if (Name !== "User") { -%>
import { UserFragment } from "@web/graphql/generated/fragments/user.fragment";
<% } -%>
<% Object.entries(fields).filter(([, field]) => !!field.initialize).forEach(([fieldName,]) => { -%>
import { initialize<%= Name %><%= h.changeCase.pascal(fieldName) %> } from "@web/graphql/schema/initializers";
<% }); -%>

export type <%= Name %>Data = Partial<<%= Name %>CreationInput> & { id?: ID };
// export type <%= Name %>Data = InputData<<%= Name %>>;
// export type Initial<%= Name %>Data = InitialData<<%= Name %>, "rank" | "userId">;

export function initialize<%= Name %>Data(data: Partial<<%= Name %>Data>, user?: UserFragment | null | undefined): Partial<<%= Name %>Data> {
<% if (requireUserId) { -%>
  if (!user) return data;
<% } -%>
  return {
<% if (requireUserId) { -%>
    userId: user.id,
<% } -%>
<% for (var [fieldName, field] of requiredStringFieldEntries) { -%>
    <%- fieldName %>: "",
<% } -%>
<% for (var [fieldName, field] of Object.entries(requiredFields).filter(([, field]) => field.type === "Array")) { -%>
    <%- fieldName %>: [],
<% } -%>
<% for (var [fieldName, field] of Object.entries(requiredFields).filter(([, field]) => typeof field.default !== "undefined")) { -%>
  <%- fieldName %>: <%- JSON5.stringify(field.default) %>,
<% } -%>
<% for (var [fieldName, field] of Object.entries(requiredFields).filter(([, field]) => field.initialize)) { -%>
    <%- fieldName %>: initialize<%= Name %><%= h.changeCase.pascal(fieldName) %>(user),
<% } -%>
    ...(Object.fromEntries(Object.entries(data).filter(([, value]) => value !== undefined))), // TODO: make this unnecessary
  };
}

export function <%= name %>Reducer(state: <%= Name %>Data, payload: Payload<<%= Name %>Data>) {
  if (payload.field === "init") return initialize<%= Name %>Data(payload.value as Partial<<%= Name %>Data>);
  return { ...state, [payload.field]: payload.value };
}

export function <%= names %>Reducer(state: <%= Name %>Fragment[], action: ArrayAction<<%= Name %>Fragment>) {
  return arrayReducer<<%= Name %>Fragment>(state, action);
}
